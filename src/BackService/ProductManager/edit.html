<!doctype html>
<html class="x-admin-sm">

<head>
    <meta charset="UTF-8">
    <title>E地跑运营平台</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <meta http-equiv="Expires" CONTENT="-1">
    <meta http-equiv="Cache-Control" CONTENT="no-cache">
    <meta http-equiv="Pragma" CONTENT="no-cache">
    <link rel="stylesheet" href="../../css/font.css">
    <link rel="stylesheet" href="../../css/xadmin.css?VERSION">
    <!-- <link rel="stylesheet" href="./css/theme5.css"> -->
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script src="https://mapapi.careland.com.cn/api/?key=6012dcd6278a2d4db3840604&v=1.3"></script>
    <script type="text/javascript" src="../../lib/layui/layui.js"></script>
    <script type="text/javascript" src="../../js/common.js?VERSION"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
          <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
          <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    <script>
        // 是否开启刷新记忆tab功能
    // var is_remember = false;
    </script>
    <style type="text/css">
        .layui-form-item{

        }
        .layui-form-label{
            text-align: left;
            padding-left: 0;
            display: block;
            float: none;
        }
        .layui-input-block{
            display: block;
            margin-left: 0;
            padding-right: 30px;
        }
        #detailAddress{
            display: inline-block;
            width: calc(100% - 50px);
        }
        #map{
            position: fixed;
            top: -1000;
        }
        .select-map-dialog {
          width: 100%;
          height: 100%;
          position: relative;
        }
        .select-map-dialog #select-map {
          width: 100%;
          height: 470px;
        }
        .select-map-dialog .select-location {
          width: 500px;
          position: absolute;
          top: 20px;
          left: 50%;
          margin-left: -250px;
          font-size: 0;
          z-index: 9999;
        }
        .select-map-dialog .select-location .label {
          font-size: 12px;
        }
        .select-map-dialog .select-location .location-name {
          display: inline-block;
          width: 400px;
          height: 28px;
          line-height: 28px;
          border: 1px solid #aaaaaa;
          border-right: 0;
          font-size: 12px;
          text-align: left;
          padding-left: 10px;
          color: #333;
          background: #fff;
        }
        .select-map-dialog .select-location .select-btn {
          position: relative;
          top: -4px;
        }
    </style>
</head>

<body>
    <div class="layui-fluid">
        <div class="layui-row">
            <form class="layui-form" lay-filter="edit">
                <div class="layui-card">
                    <div class="layui-card-header">基础信息</div>
                    <div class="layui-card-body">
                        <div class="layui-fluid">
                            <div class="layui-row">
                                <div class="layui-col-xs4">
                                    <div class="layui-form-item">
                                        <label for="productName" class="layui-form-label">
                                            <span class="x-red">*</span>网点名称
                                        </label>
                                        <div class="layui-input-block">
                                            <input type="text" id="productName" name="productName" lay-verify="required|productName" autocomplete="off" class="layui-input">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-xs4">
                                    <div class="layui-form-item">
                                        <label for="detailAddress" class="layui-form-label">
                                            <span class="x-red">*</span>详细地址
                                        </label>
                                        <div class="layui-input-block">
                                            <div id="map"></div>
                                            <input type="text" id="detailAddress" name="detailAddress" lay-verify="required|detailAddress" autocomplete="off" class="layui-input" placeholder="请选择地址">
                                            <button type="button" class="layui-btn" id="openMap">选择</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-xs4">
                                    <div class="layui-form-item">
                                        <label for="supplierNo" class="layui-form-label">
                                            <span class="x-red">*</span>归属供应商
                                        </label>
                                        <div class="layui-input-block">
                                            <select name="supplierNo" id="supplierNo">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-row">
                                <div class="layui-col-xs4">
                                    <div class="layui-form-item">
                                        <label for="contractName" class="layui-form-label">
                                            联系人
                                        </label>
                                        <div class="layui-input-block">
                                            <input type="text" id="contractName" name="contractName" lay-verify="contractName" autocomplete="off" class="layui-input">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-xs4">
                                    <div class="layui-form-item">
                                        <label for="contractPhone" class="layui-form-label">
                                            联系人手机号
                                        </label>
                                        <div class="layui-input-block">
                                            <input type="text" id="contractPhone" name="contractPhone" lay-verify="contractPhone" autocomplete="off" class="layui-input">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-xs4">
                                    <div class="layui-form-item">
                                        <label for="contractPhone" class="layui-form-label">
                                            <span class="x-red">*</span>状态
                                        </label>
                                        <div class="layui-input-block">
                                            <select name="status">
                                                <option value="1">有效</option>
                                                <option value="2">失效</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-card">
                    <div class="layui-card-header">价格信息</div>
                    <div class="layui-card-body">
                        <div class="layui-fluid">
                            <div class="layui-row">
                                <div class="layui-col-xs4">
                                    <div class="layui-form-item">
                                        <label for="unitPrice" class="layui-form-label">
                                            <span class="x-red">*</span>单价
                                        </label>
                                        <div class="layui-input-block">
                                            <input type="text" id="unitPrice" name="unitPrice" lay-verify="required|unitPrice" autocomplete="off" class="layui-input">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-xs4">
                                    <div class="layui-form-item">
                                        <label for="effectiveTime" class="layui-form-label">
                                            <span class="x-red">*</span>生效时间
                                        </label>
                                        <div class="layui-input-block">
                                            <input type="text" id="effectiveTime" name="effectiveTime" lay-verify="required" autocomplete="off" class="layui-input">
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>

                    </div>
                </div>
                <div class="layui-card">
                    <div class="layui-card-header">其他信息</div>
                    <div class="layui-card-body">
                        <div class="layui-form-item">
                            <label class="layui-form-label">备注</label>
                            <div class="layui-input-block">
                              <textarea name="remark" placeholder="请输入备注说明" lay-verify="remark" class="layui-textarea"></textarea>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-input-block" style="text-align:center;">
                                <button class="layui-btn layui-btn-lg" lay-filter="edit" lay-submit>修改</button>
                            </div>
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div>
    <script id="selectDom" type="text/html">
        {{#  layui.each(d.list, function(index, item){ }}
            <option value="{{item.supplierNo}}">{{item.supplierName}}</option>
        {{# }) }}
    </script>
    <script id="selectMapDialog" type="text/html">
        <div class="select-map-dialog">
            <div id="select-map"></div>
            <div style="padding-top: 10px;text-align: center;">当前选择地址：<span id="select-address"></span></div>
            <div class="select-location">
                <input class="location-name" name="keyword" id="seachLocation" autocomplete="off" placeholder="请输入位置" value=""/>
                <button type="button" class="layui-btn layui-btn-sm select-btn" id="regionMapPoint">搜索</button>
            </div>
        </div>
    </script>
    <script type="text/javascript">

    layui.use(['form', 'layer', 'element','laytpl','laydate'], function(form, layer, element, laytpl, laydate) {
        var xadmin = layui.xadmin,
            edipao = layui.edipao,
            detailAddress;
        //凯立德地图API功能
        var point = new Careland.Point(411067452,81446126); //创建坐标点
        var map = new Careland.Map('map', point, 12); //实例化地图对象
        map.enableAutoResize(); //启用自动适应容器尺寸变化
        map.load(); 

        var ac = new Careland.Autocomplete({input : "detailAddress",location : map});
        ac.setLocation(map);
        ac.setInputForm('detailAddress');
        ac.addEventListener("onConfirm",function(e){
            detailAddress = {
                address: e.item.poi.address + e.item.poi.name,
                lat: e.item.poi.pointGb.lat,
                lng: e.item.poi.pointGb.lng,
            };
            $('#detailAddress').val(detailAddress.address)
            ac.hide();
        });


        $('#openMap').on('click',function(){
            layer.open({
                type: 1,
                title: "选择地址",
                area: ['900px', $(window).height() - 50 + 'px'],
                content: selectMapDialog.innerHTML,
                btn: ['取消', '确定'],
                btnAlign: 'c',
                zIndex:9991, //层优先级
                cancel: function () {
                   
                },
                btn2: function(){
                    if(detailAddress){
                        $('#detailAddress').val(detailAddress.address);
                    }
                },
                success: function () {
                    //凯立德地图API功能
                    var point = new Careland.Point(419364916, 143908009);
                    var map = new Careland.Map('select-map', point, 15); 
                    map.enableAutoResize();      
                    map.load(); 

                    var myGeo = new Careland.Geocoder();

                    var layer = new Careland.Layer('point', 'layer');
                    var style = new Careland.PointStyle({offsetX:-11,offsetY:-30,textOffsetX:-5,textOffsetY:-30,src:'https://www.d.edipao.cn/admin/images/center.png',fontColor:'#000'});
                    layer.setStyle(style);
                    map.addLayer(layer);

                    var mapInfoWin = new Careland.InfoWindow();
                    mapInfoWin.setOffset(new Careland.Size(0, -22));

                    var ac = new Careland.Autocomplete({input : "seachLocation",location : map});
                    ac.setLocation(map);
                    ac.setInputForm('seachLocation');
                    ac.addEventListener("onConfirm",function(e){
                        mapInfoWin.setContent('当前地址：' + e.item.poi.name);
                        mapInfoWin.redraw();
                        layer.clear();
                        var marker = new Careland.Marker('image');
                        marker.setPoint(e.item.poi.point);
                        layer.add(marker);
                        marker.openInfoWindow(mapInfoWin);
                        detailAddress = {
                            address: e.item.poi.address + e.item.poi.name,
                            lat: e.item.poi.pointGb.lat,
                            lng: e.item.poi.pointGb.lng,
                        }
                        $('#seachLocation').val(detailAddress.address);
                        $('#select-address').text(detailAddress.address);
                        map.centerAndZoom(e.item.poi.point, 15);
                    });

                    $('#regionMapPoint').off('click').on('click', function(){
                        var searchTxt = $('#seachLocation').val();
                        var poiSearch = new Careland.LocalSearch(map,{
                            map: map,
                            selectFirstResult:false,
                            autoViewport:true,
                            onMarkersSet: function(pois){
                                layui.each(pois, function(v, k){
                                    var marker = k.marker;
                                    marker.addEventListener('click', function(e){
                                        e.event.defaultPrevented = true;
                                        layer.clear();
                                        myGeo.getLocation(e.point,function(data){
                                            mapInfoWin.setContent('当前地址：' + data.address);
                                            mapInfoWin.redraw();
                                            marker.openInfoWindow(mapInfoWin);
                                            console.log(data)
                                            detailAddress = {
                                                address: data.address,
                                                lat: edipao.kcodeToGb(data.kcode).lat,
                                                lng: edipao.kcodeToGb(data.kcode).lng,
                                            }
                                            $('#seachLocation').val(detailAddress.address);
                                            $('#select-address').text(detailAddress.address);
                                        });
                                    })
                                })
                            },
                        });
                        poiSearch.search(searchTxt);
                    })

                    map.addEventListener('click', function(point){
                        var point = point;
                        if(!point || typeof (point) != "object"){
                            return;
                        }
                        myGeo.getLocation(point,function(data){
                            layer.clear();
                            //创建文本标注点
                            var marker = new Careland.Marker('image');
                            marker.setPoint(point);
                            layer.add(marker);

                            mapInfoWin.setContent('当前地址：' + data.address);
                            mapInfoWin.redraw();
                            marker.openInfoWindow(mapInfoWin);
                            detailAddress = {
                                address: data.address,
                                lat: edipao.kcodeToGb(data.kcode).lat,
                                lng: edipao.kcodeToGb(data.kcode).lng,
                            }
                            $('#seachLocation').val(detailAddress.address);
                            $('#select-address').text(detailAddress.address);
                        });
                    });
                   
                }
            })
        })


        laydate.render({
            elem: '#effectiveTime',
            type: 'datetime'
          });

        var params = edipao.urlGet();

        edipao.request({
            type: 'get',
            url:'/admin/supplier/all'
        }).then(function(res){
            if(res.code == 0){
                laytpl(selectDom.innerHTML).render({list: res.data},function(html){
                    document.getElementById('supplierNo').innerHTML = html;
                })
                form.render();
                getDetail();
            }
        })
        function getDetail(){
            edipao.request({
                type: 'get',
                url: '/admin/product/detail',
                data: {
                    productNo: params.id
                }
            }).then(function(res) {
                if (res.code == 0) {
                    detailAddress = {
                        address: res.data.detailAddress,
                        lng: res.data.lng,
                        lat: res.data.lat
                    }
                    form.val("edit", res.data);
                }
            })
        }
        

        
        //自定义验证规则
        form.verify({
            productName: function(value) {
                if (value.length > 50) {
                    return '网点名称不能超出50个字符';
                }  
            },
            detailAddress: function(value) {
                if( !detailAddress || detailAddress.address != value){
                   return '请选择地址'; 
                }
            },
            contractName: function(value) {
                if (value.length > 50) {
                    return '联系人姓名不能超过50个字符';
                }
            },
            contractPhone: function(value){
                if (value !== '' && !/^1\d{10}$/.test(value) && !/^0\d{2,3}-?\d{7,8}$/.test(value)) {
                    return '手机号或固定电话格式不正确';
                }
            },
            unitPrice: function(value){
                if(!/^\d+(?=\.{0,1}\d+$|$)/.test(value)){
                    return '单价格式不正确';
                }
                if(parseFloat(value) > 10000){
                    return '单价不能超过10000';
                }
            },
            remark: function(value){
                if (value.length > 300) {
                    return '备注不能超过300个字符';
                }
            }
        });

        form.on('submit(edit)', function(data) {
            data.field.productNo = params.id;
            data.field.lng = detailAddress.lng;
            data.field.lat = detailAddress.lat;
            edipao.request({
                url: '/admin/product/update',
                data: data.field,
            }).done(function(res) {
                if (res.code == 0) {
                    layer.alert("网点修改成功", { icon: 6 ,
                        end: function(){
                            xadmin.close();
                            xadmin.father_reload();
                        }
                    });
                } else {
                    layer.msg(res.message)
                }
            })
            return false;
        });
    })
    </script>
</body>

</html>