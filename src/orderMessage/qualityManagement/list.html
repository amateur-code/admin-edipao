<!doctype html>
<html class="x-admin-sm">
<head>
  <meta charset="UTF-8">
  <title>E地跑运营平台</title>
  <meta name="renderer" content="webkit|ie-comp|ie-stand">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
  <meta http-equiv="Expires" CONTENT="-1">
  <meta http-equiv="Cache-Control" CONTENT="no-cache">
  <meta http-equiv="Pragma" CONTENT="no-cache">
  <link rel="stylesheet" href="../../css/font.css">
  <link rel="stylesheet" href="../../css/xadmin.css">
  <link rel="stylesheet" href="../../lib/TableFilter/tableFilter.css">
  <!-- <link rel="stylesheet" href="./css/theme5.css"> -->
  <script type="text/javascript" src="../../js/jquery.min.js"></script>
  <script type="text/javascript" src="../../lib/layui/layui.js"></script>
  <script type="text/javascript" src="../../js/common.js?VERSION"></script>
  <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
  <!--[if lt IE 9]>
  <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
  <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <script>
  // 是否开启刷新记忆tab功能
  // var is_remember = false;
  </script>
  <style type="text/css">
    .layui-table-tool-temp {
      padding-right: 0;
    }

    .layui-btn-container {
      text-align: right;
    }

    .opeartion_icon {
      cursor: pointer;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 45px;
    }
  </style>
</head>
<body>
<div class="x-nav">
        <span class="layui-breadcrumb">
            <a>业务管理</a>
            <a>
                <cite>品质管理</cite>
            </a>
        </span>
  <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right"
     onclick="location.reload()"
     title="刷新">
    <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
  </a>
</div>
<!--<div class="layui-fluid" style="background-color: #fff;">-->
<!--  <div class="layui-row layui-col-space15">-->
<!--    <div class="layui-col-md12">-->
<!--      <div class="layui-tab" lay-filter="test1">-->
<!--        <ul class="layui-tab-title">-->
<!--          <li class="layui-this" lay-id="111">订单</li>-->
<!--          <li lay-id="222">车辆</li>-->
<!--          <li lay-id="333">时效配置</li>-->
<!--        </ul>-->
<!--        <div class="layui-tab-content">-->
<!--          <div class="layui-tab-item layui-show">-->

<!--                    frameborder="0"-->
<!--                    width="100%"-->
<!--                    height="500px">-->
<!--            </iframe>-->
<!--          </div>-->
<!--          <div class="layui-tab-item">-->
<!--            <iframe src="../vehicle/list-car.html"-->
<!--                    frameborder="0"-->
<!--                    width="100%"-->
<!--                    height="500px">-->
<!--            </iframe>-->
<!--            &lt;!&ndash;            onload="iframeAutoHeight(this)"&ndash;&gt;-->
<!--          </div>-->
<!--          <div class="layui-tab-item">-->
<!--            <iframe src="../agingConfiguration/aging.html"-->
<!--                    frameborder="0"-->
<!--                    width="100%"-->
<!--                    height="500px"/>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</div>-->
<div class="layui-fluid" style="background-color: #fff;">
  <div class="layui-row layui-col-space15">
    <div class="layui-col-md12">
      <table id="costList3" lay-filter="costList3"></table>
    </div>
  </div>
</div>
<script type="text/html" id="headerBtns">
<div class="layui-btn-container">
  <button id="reset_search" data-event="reset_search" lay-event="reset_search" class="top_tool_bar layui-btn">重置搜索
  </button>
  {{# if(permissionList.indexOf('新增') != -1){ }}
  <button class="layui-btn layui-btn-sm" lay-event="add">新增</button>
  {{# } }}
  {{# if(permissionList.indexOf('导出') != -1){ }}
  <button class="layui-btn layui-btn-sm" lay-event="export">导出</button>
  {{# } }}
  <button class="layui-btn layui-btn-sm" lay-event="exportLog">导出日志</button>
  <button class="layui-btn layui-btn-sm" id="aaaaaa" lay-event="tableSet">表格设置</button>
</div>
</script>
<script type="text/html" id="rowBtns">
{{# if(permissionList.indexOf('修改') != -1){ }}
<a class="layui-btn layui-btn-xs layui-bg-blue" lay-event="edit">修改</a>
{{# } }}
{{# if(d.showApprovalBtn){ }}
<a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="audit">审核</a>
{{# } }}
<a class="layui-btn layui-btn-xs layui-bg-blue" lay-event="preview">查看</a>
{{# if(permissionList.indexOf('删除') != -1){ }}
<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</a>
{{# } }}
<a class="layui-btn layui-btn-xs layui-bg-blue" lay-event="log">日志</a>
</script>
<script type="text/javascript">
//定义时间转换函数
function dateConvert (dateParms) {
  if (dateParms && dateParms != 0 && dateParms != undefined && dateParms != null) {
    var r = dateParms.toString().replace(/^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})$/, "$1-$2-$3 $4:$5:$6")
  }
  //返回处理结果
  return r;
}

layui.config({
  base: '../../lib/'
}).extend({
  excel: 'layui_exts/excel.min',
  tableFilter: 'TableFilter/tableFiltercopy'
}).use(['table', 'layer', 'excel', 'tableFilter', 'element'], function (table, layer, excel, tableFilter, element) {
  var reloadOption = null;
  var xadmin = layui.xadmin,
    edipao = layui.edipao,
    tableKey = 'qualityManagement-list',
    tableCols = [ //表头
      { checkbox: true },
      { field: 'orderNo', title: '业务单号', width: 200 },
      {
        field: 'orderType', title: '订单类型', width: 200, templet: function (d) {
          if (d.orderType === 1) {
            return '单车单' || '- -'
          } else {
            return '背车单' || '- -'
          }
        }
      },
      {
        field: 'vinCode', title: 'vin码', width: 200, templet: function (d) {
          return d.vinCode || '- -'
        }
      },
      {
        field: 'transportAssignTime', title: '运输商指派时间', width: 200, align: 'center', templet: function (d) {
          return dateConvert(d.transportAssignTime) || '- -'
        }
      },
      {
        field: 'endPark', title: '收车网点', width: 200, align: 'center', templet: function (d) {
          return d.endPark || '- -'
        }
      },
      {
        field: 'driverName', title: '司机信息', width: 200, align: 'center', templet: function (d) {
          if (!d.driverName && !d.driverPhone) {
            return '- -'
          } else {
            return d.driverName + '-' + d.driverPhone
          }
        }
      },
      {
        field: 'latestArriveTime', title: '最迟送达时间', width: 200, align: 'center', templet: function (d) {
          return dateConvert(d.latestArriveTime) || '- -'
        }
      },
      {
        field: 'orderStatus', title: '状态', width: 200, align: 'center', templet: function (d) {
          if (d.orderStatus === 1) {
            return '待调度'
          } else if (d.orderStatus === 2) {
            return '待发车'
          } else if (d.orderStatus === 3) {
            return '运输中'
          } else if (d.orderStatus === 4) {
            return '已收车'
          } else if (d.orderStatus === 5) {
            return '已完结'
          } else if (d.orderStatus === 6) {
            return '已取消'
          } else {
            return '- -'
          }
        }
      },
      {
        field: 'createOrderStatus', title: '转单', width: 200, align: 'center', templet: function (d) {
          if (d.createOrderStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.createOrderTime === 0 ? '' : dateConvert(d.createOrderTime)) + '</p>'
          } else if (d.createOrderStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.createOrderDelay + '小时<p style="line-height: 14px;">' + (d.createOrderTime === 0 ? '' : dateConvert(d.createOrderTime)) + '</p>'
          }
        }
      },
      {
        field: 'dispatchStatus', title: '调度', width: 200, align: 'center', templet: function (d) {
          if (d.dispatchStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.dispatchTime === 0 ? '' : dateConvert(d.dispatchTime)) + '</p>'
          } else if (d.dispatchStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.dispatchDelay + '小时<p style="line-height: 14px;">' + (d.dispatchTime === 0 ? '' : dateConvert(d.dispatchTime)) + '</p>'
          }
        }
      },
      {
        field: 'startStatus', title: '发车', width: 200, align: 'center', templet: function (d) {
          if (d.startStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.startTime === 0 ? '' : dateConvert(d.startTime)) + '</p>'
          } else if (d.startStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.startDelay + '小时<p style="line-height: 14px;">' + (d.startTime === 0 ? '' : dateConvert(d.startTime)) + '</p>'
          }
        }
      },
      {
        field: 'outCityStatus', title: '出城', width: 200, align: 'center', templet: function (d) {
          if (d.outCityStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.outCityTime === 0 ? '' : dateConvert(d.outCityTime)) + '</p>'
          } else if (d.outCityStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.outCityDelay + '小时<p style="line-height: 14px;">' + (d.outCityTime === 0 ? '' : dateConvert(d.outCityTime)) + '</p>'
          }
        }
      },
      {
        field: 'location', title: '当前位置', width: 200, align: 'center', templet: function (d) {
          if (d.location !== '' && d.locationTime !== 0) {
            return '<p style="line-height: 14px">' + d.location + '</p><p style="line-height: 14px">' + dateConvert(d.locationTime) + '</p>'
          } else if (d.location === '' && d.locationTime !== 0) {
            return '<p style="line-height: 14px">' + dateConvert(d.locationTime) + '</p>'
          } else if (d.location !== '' && d.locationTime === 0) {
            return '<p style="line-height: 14px">' + d.location + '</p>'
          } else {
            return '- -'
          }
        }
      },
      {
        field: 'deviateWay', title: '线路偏移', width: 200, align: 'center', templet: function (d) {
          if (d.deviateWay === 0) {
            return '- -'
          } else {
            return (d.deviateWay * 1).toFixed(2) + 'KM'
          }

        }
      },
      {
        field: 'estimatedArriveTime', title: '预计送达时间', width: 200, align: 'center', templet: function (d) {
          return dateConvert(d.estimatedArriveTime) || '- -'
        }
      },
      {
        field: 'returnStatus', title: '交车迟到', width: 200, align: 'center', templet: function (d) {
          if (d.returnStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.returnTime === 0 ? '' : dateConvert(d.returnTime)) + '</p>'
          } else if (d.returnStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.returnDelay + '小时<p style="line-height: 14px;">' + (d.returnTime === 0 ? '' : dateConvert(d.returnTime)) + '</p>'
          }
        }
      },
      {
        field: 'dealerReceiveStatus', title: '扫码收车', width: 200, align: 'center', templet: function (d) {
          if (d.dealerReceiveStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.dealerReceiveTime === 0 ? '' : dateConvert(d.dealerReceiveTime)) + '</p>'
          } else if (d.dealerReceiveStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.dealerReceiveDelay + '小时<p style="line-height: 14px;">' + (d.dealerReceiveTime === 0 ? '' : dateConvert(d.dealerReceiveTime)) + '</p>'
          }
        }
      },
      {
        field: 'dealerSignStatus', title: '合格证签收', width: 200, align: 'center', templet: function (d) {
          if (d.dealerSignStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.dealerSignTime === 0 ? '' : dateConvert(d.dealerSignTime)) + '</p>'
          } else if (d.dealerSignStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.dealerSignDelay + '小时<p style="line-height: 14px;">' + (d.dealerSignTime === 0 ? '' : dateConvert(d.dealerSignTime)) + '</p>'
          }
        }
      },
      {
        field: 'damageApprovalStatus', title: '车损报备审核', width: 200, align: 'center', templet: function (d) {
          if (d.damageApprovalStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.damageApprovalTime === 0 ? '' : dateConvert(d.damageApprovalTime)) + '</p>'
          } else if (d.damageApprovalStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.damageApprovalDelay + '小时<p style="line-height: 14px;">' + (d.damageApprovalTime === 0 ? '' : dateConvert(d.damageApprovalTime)) + '</p>'
          }
        }
      },
      {
        field: 'timeInvalidStatus', title: '时效违背', width: 200, align: 'center', templet: function (d) {
          if (d.timeInvalidStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.timeInvalid === 0 ? '' : dateConvert(d.timeInvalid)) + '</p>'
          } else if (d.timeInvalidStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.timeInvalidDelay + '小时<p style="line-height: 14px;">' + (d.timeInvalid === 0 ? '' : dateConvert(d.timeInvalid)) + '</p>'
          }
        }
      },
      {
        field: 'returnImgApprovalStatus',
        title: '回单审核',
        width: 200,
        align: 'center',
        templet: function (d) {
          if (d.returnImgApprovalStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.returnImgApprovalTime === 0 ? '' : dateConvert(d.returnImgApprovalTime)) + '</p>'
          } else if (d.returnImgApprovalStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.returnImgApprovalDelay + '小时<p style="line-height: 14px;">' + (d.returnImgApprovalTime === 0 ? '' : dateConvert(d.returnImgApprovalTime)) + '</p>'
          }
        }
      },
      {
        field: 'prePayStatus', title: '预付款支付', width: 200, align: 'center', templet: function (d) {
          if (d.prePayStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.prePayTime === 0 ? '' : dateConvert(d.prePayTime)) + '</p>'
          } else if (d.prePayStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.prePayDelay + '小时<p style="line-height: 14px;">' + (d.prePayTime === 0 ? '' : dateConvert(d.prePayTime)) + '</p>'
          }
        }
      },
      {
        field: 'arrivePayStatus', title: '到付款支付', width: 200, align: 'center', templet: function (d) {
          if (d.arrivePayStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.arrivePayTime === 0 ? '' : dateConvert(d.arrivePayTime)) + '</p>'
          } else if (d.arrivePayStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.arrivePayDelay + '小时<p style="line-height: 14px;">' + (d.arrivePayTime === 0 ? '' : dateConvert(d.arrivePayTime)) + '</p>'
          }
        }
      },
      {
        field: 'tailPayStatus', title: '尾款支付', width: 200, align: 'center', templet: function (d) {
          if (d.tailPayStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.tailPayTime === 0 ? '' : dateConvert(d.tailPayTime)) + '</p>'
          } else if (d.tailPayStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.tailPayDelay + '小时<p style="line-height: 14px;">' + (d.tailPayTime === 0 ? '' : dateConvert(d.tailPayTime)) + '</p>'
          }
        }
      },
      {
        field: 'reportHandleStatus', title: '上报处理', width: 200, align: 'center', templet: function (d) {
          if (d.reportHandleStatus === 1) {
            return '<p style="line-height: 14px">正常</p><p style="line-height: 14px">' + (d.reportHandleTime === 0 ? '' : dateConvert(d.reportHandleTime)) + '</p>'
          } else if (d.reportHandleStatus === 2) {
            return '<p style="line-height: 14px;color: #EE5B22;">延迟' + d.reportHandleDelay + '小时<p style="line-height: 14px;">' + (d.reportHandleTime === 0 ? '' : dateConvert(d.reportHandleTime)) + '</p>'
          }
        }
      }
    ],
    tableIns,
    tableFilterIns,
    tableWhere = {
      loginStaffId: edipao.getLoginStaffId()
    },
    permissionList = edipao.getMyPermission();
  window.permissionList = permissionList;

  edipao.request({
    type: 'GET',
    url: '/admin/table/show-field/get',
    data: {
      tableName: tableKey
    }
  }).done(function (res) {
    if (res.code == 0) {
      if (res.data) {
        var showList = [];
        try {
          showList = JSON.parse(res.data);
        } catch (e) {
        }
        layui.each(tableCols, function (index, item) {
          if (item.field == "operation") return;
          if (item.field && showList.indexOf(item.field) == -1) {
            item.hide = true;
          }
        })
      }
      renderTable();
    }
  })
  var resizeTime = null;

  function resizeTable () {
    var w = "100px";
    var backw = "350px";
    var backl = "-1px";
    var l = "-250px";
    var dur = 500;
    $(".opeartion_icon").removeClass("layui-icon-next").addClass("layui-icon-prev");
    if (resizeTime) clearTimeout(resizeTime);
    resizeTime = setTimeout(function () {
      $(".layui-table-main td[data-field=operation]").css("border-color", "#ffffff").css("background", "#ffffff").find(".layui-table-cell").css("width", w).html("");
      $(".layui-table-box>.layui-table-header th[data-field=operation]").css("border", "none").css("color", "#f2f2f2");
      var $fixed = $(".layui-table-fixed.layui-table-fixed-r");
      $fixed.removeClass("layui-hide").find(".layui-table-body").css("height", "auto");
      $fixed.find(".layui-table-header").css("overflow", "visible")
      $fixed.find(".layui-table-filter").css("left", "60px");
      $fixed.find("thead .layui-table-cell").css("position", "relative");
      if (!$fixed.find(".opeartion_icon").length) $fixed.find("thead .layui-table-cell").append("<i class='layui-icon opeartion_icon layui-icon-prev'></i>");
      $fixed.animate({ "right": l }, 500, function () {
        $(".opeartion_icon").unbind().on("click", function (e) {
          var $this = $(this);
          if ($this.hasClass("layui-icon-prev")) {
            $(".layui-table-main td[data-field=operation] .layui-table-cell").css("width", backw);
            $this.removeClass("layui-icon-prev").addClass("layui-icon-next");
            $fixed.animate({ "right": backl }, 500);
          } else {
            $(".layui-table-main td[data-field=operation] .layui-table-cell").css("width", w);
            $this.removeClass("layui-icon-next").addClass("layui-icon-prev");
            $fixed.animate({ "right": l }, 500);
          }
        });
      });
    }, dur);
  }

  function renderTable () {
    tableIns = table.render({
      id: 'costList3',
      elem: '#costList3',
      // method: 'post',
      url: edipao.API_HOST + '/admin/quality/order/list',
      request: {
        pageName: 'pageNo',
        limitName: 'pageSize'
      },
      where: tableWhere,
      parseData: function (res) { //res 即为原始返回的数据
        console.log(res)
        edipao.codeMiddleware(res);
        return {
          code: res.code, //解析接口状态
          msg: res.message, //解析提示文本
          count: res.data.totalSize, //解析数据长度
          data: res.data.qualityOrderList //解析数据列表
        };
      },
      page: true,
      cols: [tableCols],
      toolbar: '#headerBtns',
      defaultToolbar: [],
      done: function (res, curr, count) {
        $(window).unbind("resize");
        resizeTable();
        if (res.data == null) {
          $('.layui-table-header').css('overflow-x', 'scroll')
        } else {
          $('.layui-table-header').css('overflow', 'hidden')
        }
        if (reloadOption) {
          tableIns.reload(JSON.parse(JSON.stringify(reloadOption)));
          reloadOption = false;
        }
        tableFilterIns && tableFilterIns.reload() // 搜索
      }
    });

    let filtersHeader = [];
    layui.each(tableCols, function (index, el) {
      if (el.field) {
        let item = { field: el.field };
        if (el.field == "transportAssignTime" || el.field == "latestArriveTime" || el.field == "createOrderStatus" || el.field == "dispatchStatus" || el.field == "startStatus" || el.field == "outCityStatus" || el.field == "estimatedArriveTime" || el.field == "returnStatus" || el.field == "dealerReceiveStatus" || el.field == "dealerSignStatus" || el.field == "timeInvalidStatus" || el.field == "returnImgApprovalStatus" || el.field == "prePayStatus" || el.field == "arrivePayStatus" || el.field == "tailPayStatus" || el.field == "reportHandleStatus") {
          item.type = 'timeslot'
        } else if (el.field == 'orderType') {
          item.type = 'checkbox'
          item.data = [
            { "key": "1", "value": "单车单" },
            { "key": "2", "value": "背车单" }
          ]
        } else if (el.field == 'orderStatus') {
          item.type = 'checkbox'
          item.data = [
            { "key": "1", "value": "待调度" },
            { "key": "2", "value": "待发车" },
            { "key": "3", "value": "运输中" },
            { "key": "4", "value": "已收车" },
            { "key": "5", "value": "已完结" },
            { "key": "6", "value": "已取消" },
          ]
        } else if (el.field == 'driverName') {
          item.type = "contract"
        } else if (el.field == 'deviateWay') {
          item.type = 'numberslot'
        }
        if (el.field != "operation") {
          filtersHeader.push(item)
        }
      }
    });
    tableFilterIns = tableFilter.render({
      elem: '#costList3',
      mode: 'self',
      filters: filtersHeader,//过滤项配置
      done: function (filters, reload) {
        filters = $.extend({}, filters);
        let index = 0,
          where = {
            loginStaffId: edipao.getLoginStaffId()
          };
        layui.each(filters, function (key, value) {
          where['searchFieldDTOList[' + index + '].fieldName'] = key;
          if (key == 'deviateWay') {
            where['searchFieldDTOList[' + index + '].fieldMinValue'] = value[0];
            where['searchFieldDTOList[' + index + '].fieldMaxValue'] = value[1];
          } else if (key == 'orderType' || key == 'orderStatus') {
            where['searchFieldDTOList[' + index + '].fieldListValue'] = value.join(',');
          } else if (key == "transportAssignTime" || key == "latestArriveTime" || key == "createOrderStatus" || key == "dispatchStatus" || key == "startStatus" || key == "outCityStatus" || key == "estimatedArriveTime" || key == "returnStatus" || key == "dealerReceiveStatus" || key == "dealerSignStatus" || key == "timeInvalidStatus" || key == "returnImgApprovalStatus" || key == "prePayStatus" || key == "arrivePayStatus" || key == "tailPayStatus" || key == "reportHandleStatus") {
            // where['searchFieldDTOList[' + index + '].fieldName'] = key;
            value = value.split(" 至 ");
            where['searchFieldDTOList[' + index + '].fieldMinValue'] = value[0];
            where['searchFieldDTOList[' + index + '].fieldMaxValue'] = value[1];
          } else if (key == "driverName") {
            if (value[0]) {
              where["searchFieldDTOList[" + index + "].fieldName"] = "driverName";
              where["searchFieldDTOList[" + index + "].fieldValue"] = value[0];
            }
            if (value[0] && value[1]) index++;
            if (value[1]) {
              where["searchFieldDTOList[" + index + "].fieldName"] = "driverPhone";
              where["searchFieldDTOList[" + index + "].fieldValue"] = value[1];
            }
          } else {
            where['searchFieldDTOList[' + index + '].fieldValue'] = value;
          }
          index++;
        })
        tableWhere = where;
        if (reload) {
          reloadOption = { where: where, page: { curr: 1 } };
        } else {
          tableIns.reload({ where: where, page: { curr: 1 } });
        }
      }
    })

  }

  function handleEvent (obj) {
    var data = obj.data;
    obj.event == 'export' && permissionList.indexOf('导出') == -1 && (obj.event = 'reject');
    switch (obj.event) {
      case 'reject':
        layer.alert('你没有访问权限', { icon: 2 });
        break;
      case 'export':
        exportData();
        break;
      case 'tableSet':
        xadmin.open('表格设置', './table-set.html', 600);
        break;
      case "exportLog":
        xadmin.open('导出日志', '../../OperateLog/log.html?type=8&action=exportLog');
        break;
      case "reset_search":
        edipao.resetSearch("costList3", function () {
          location.reload();
        });
        break;
    }
  }

  function exportData () {
    var checkStatus = table.checkStatus('costList3');
    if (checkStatus.data.length > 0) {
      exportXlsx(checkStatus.data)
      return;
    }
    let where = JSON.parse(JSON.stringify(tableWhere));
    where.pageNo = 1;
    where.pageSize = 10000;
    edipao.request({
      type: 'GET',
      url: '/admin/quality/order/list',
      data: where
    }).then(function (res) {
      if (res.code == 0) {
        exportXlsx(res.data.qualityOrderList);
      }
    })
  }

  function exportXlsx (list) {
    list.forEach(item => {
      if (item.driverName !== '' && item.driverPhone !== '') {
        item.driverName = item.driverName + '-' + item.driverPhone
      } else if (item.driverName !== '' && item.driverPhone === '') {
        item.driverName = item.driverName
      } else if (item.driverName === '' && item.driverPhone !== '') {
        item.driverName = item.driverPhone
      } else if (item.driverName === '' && item.driverPhone === '') {
        item.driverName = '- -'
      }
      if (item.orderType == 1) {
        item.orderType = '单车单'
      } else if (item.orderType == 2) {
        item.orderType = '背车单'
      }
      if (item.transportAssignTime) {
        item.transportAssignTime = dateConvert(item.transportAssignTime)
      }
      if (item.latestArriveTime) {
        item.latestArriveTime = dateConvert(item.latestArriveTime)
      }
      if (item.estimatedArriveTime) {
        item.estimatedArriveTime = dateConvert(item.estimatedArriveTime)
      }
      if (item.orderStatus) {
        if (item.orderStatus === 1) {
          item.orderStatus = '待调度'
        } else if (item.orderStatus === 2) {
          item.orderStatus = '待发车'
        } else if (item.orderStatus === 3) {
          item.orderStatus = '运输中'
        } else if (item.orderStatus === 4) {
          item.orderStatus = '已收车'
        } else if (item.orderStatus === 5) {
          item.orderStatus = '已完结'
        } else if (item.orderStatus === 6) {
          item.orderStatus = '已取消'
        }
      }
      if (item.orderType === 1) {
        item.orderType = '单车单'
      } else {
        item.orderType = '背车单'
      }
      if (item.createOrderStatus === 1 && item.createOrderTime === 0) {
        item.createOrderStatus = '正常'
      } else if (item.createOrderStatus === 1 && item.createOrderTime !== 0) {
        item.createOrderStatus = '正常' + dateConvert(item.createOrderTime)
      } else if (item.createOrderStatus === 2 && item.createOrderDelay === 0) {
        item.createOrderStatus = '延迟'
      } else if (item.createOrderStatus === 2 && item.createOrderDelay !== 0) {
        item.createOrderStatus = '延迟' + item.createOrderDelay + '小时'
      } else if (item.createOrderStatus === 2 && item.createOrderDelay !== 0 && item.createOrderTime !== 0) {
        item.createOrderStatus = '延迟' + item.createOrderDelay + '小时' + dateConvert(item.createOrderTime)
      }
      if (item.dispatchStatus === 1 && item.dispatchTime === 0) {
        item.dispatchStatus = '正常'
      } else if (item.dispatchStatus === 1 && item.dispatchTime !== 0) {
        item.dispatchStatus = '正常' + dateConvert(item.dispatchTime)
      } else if (item.dispatchStatus === 2 && item.dispatchDelay === 0) {
        item.dispatchStatus = '延迟'
      } else if (item.dispatchStatus === 2 && item.dispatchDelay !== 0) {
        item.dispatchStatus = '延迟' + item.dispatchDelay + '小时'
      } else if (item.dispatchStatus === 2 && item.dispatchDelay !== 0 && item.dispatchTime !== 0) {
        item.dispatchStatus = '延迟' + item.dispatchDelay + '小时' + dateConvert(item.dispatchTime)
      }
      if (item.startStatus === 1 && item.startTime === 0) {
        item.startStatus = '正常'
      } else if (item.startStatus === 1 && item.startTime !== 0) {
        item.startStatus = '正常' + dateConvert(item.startTime)
      } else if (item.startStatus === 2 && item.startDelay === 0) {
        item.startStatus = '延迟'
      } else if (item.startStatus === 2 && item.startDelay !== 0) {
        item.startStatus = '延迟' + item.startDelay + '小时'
      } else if (item.startStatus === 2 && item.startDelay !== 0 && item.startTime !== 0) {
        item.startStatus = '延迟' + item.startDelay + '小时' + dateConvert(item.startTime)
      }
      if (item.outCityStatus === 1 && item.outCityTime === 0) {
        item.outCityStatus = '正常'
      } else if (item.outCityStatus === 1 && item.outCityTime !== 0) {
        item.outCityStatus = '正常' + dateConvert(item.outCityTime)
      } else if (item.outCityStatus === 2 && item.outCityDelay === 0) {
        item.outCityStatus = '延迟'
      } else if (item.outCityStatus === 2 && item.outCityDelay !== 0) {
        item.outCityStatus = '延迟' + item.outCityDelay + '小时'
      } else if (item.outCityStatus === 2 && item.outCityDelay !== 0 && item.outCityTime !== 0) {
        item.outCityStatus = '延迟' + item.outCityDelay + '小时' + dateConvert(item.outCityTime)
      }
      if (item.returnStatus === 1 && item.returnTime === 0) {
        item.returnStatus = '正常'
      } else if (item.returnStatus === 1 && item.returnTime !== 0) {
        item.returnStatus = '正常' + dateConvert(item.returnTime)
      } else if (item.returnStatus === 2 && item.returnDelay === 0) {
        item.returnStatus = '延迟'
      } else if (item.returnStatus === 2 && item.returnDelay !== 0) {
        item.returnStatus = '延迟' + item.returnDelay + '小时'
      } else if (item.returnStatus === 2 && item.returnDelay !== 0 && item.returnTime !== 0) {
        item.returnStatus = '延迟' + item.returnDelay + '小时' + dateConvert(item.returnTime)
      }
      if (item.dealerReceiveStatus === 1 && item.dealerReceiveTime === 0) {
        item.dealerReceiveStatus = '正常'
      } else if (item.dealerReceiveStatus === 1 && item.dealerReceiveTime !== 0) {
        item.dealerReceiveStatus = '正常' + dateConvert(item.dealerReceiveTime)
      } else if (item.dealerReceiveStatus === 2 && item.dealerReceiveDelay === 0) {
        item.dealerReceiveStatus = '延迟'
      } else if (item.dealerReceiveStatus === 2 && item.dealerReceiveDelay !== 0) {
        item.dealerReceiveStatus = '延迟' + item.dealerReceiveDelay + '小时'
      } else if (item.dealerReceiveStatus === 2 && item.dealerReceiveDelay !== 0 && item.dealerReceiveTime !== 0) {
        item.dealerReceiveStatus = '延迟' + item.dealerReceiveDelay + '小时' + dateConvert(item.dealerReceiveTime)
      }
      if (item.dealerSignStatus === 1 && item.dealerSignTime === 0) {
        item.dealerSignStatus = '正常'
      } else if (item.dealerSignStatus === 1 && item.dealerSignTime !== 0) {
        item.dealerSignStatus = '正常' + dateConvert(item.dealerSignTime)
      } else if (item.dealerSignStatus === 2 && item.dealerSignDelay === 0) {
        item.dealerSignStatus = '延迟'
      } else if (item.dealerSignStatus === 2 && item.dealerSignDelay !== 0) {
        item.dealerSignStatus = '延迟' + item.dealerSignDelay + '小时'
      } else if (item.dealerSignStatus === 2 && item.dealerSignDelay !== 0 && item.dealerSignTime !== 0) {
        item.dealerSignStatus = '延迟' + item.dealerSignDelay + '小时' + dateConvert(item.dealerSignTime)
      }
      if (item.timeInvalidStatus === 1) {
        item.timeInvalidStatus = '正常'
      } else if (item.timeInvalidStatus === 1 && item.timeInvalid !== 0) {
        item.timeInvalidStatus = '正常' + dateConvert(item.timeInvalid)
      } else if (item.timeInvalidStatus === 2) {
        item.timeInvalidStatus = '延迟'
      } else if (item.timeInvalidStatus === 2 && item.timeInvalidDelay !== 0) {
        item.timeInvalidStatus = '延迟' + item.timeInvalidDelay + '小时'
      } else if (item.timeInvalidStatus === 2 && item.timeInvalidDelay !== 0 && item.timeInvalid !== 0) {
        item.timeInvalidStatus = '延迟' + item.timeInvalidDelay + '小时' + dateConvert(item.timeInvalid)
      }
      if (item.returnImgApprovalStatus === 1 && item.returnImgApprovalTime === 0) {
        item.returnImgApprovalStatus = '正常'
      } else if (item.returnImgApprovalStatus === 1 && item.returnImgApprovalTime !== 0) {
        item.returnImgApprovalStatus = '正常' + dateConvert(item.returnImgApprovalTime)
      } else if (item.returnImgApprovalStatus === 2 && item.returnImgApprovalDelay === 0) {
        item.returnImgApprovalStatus = '延迟'
      } else if (item.returnImgApprovalStatus === 2 && item.returnImgApprovalDelay !== 0) {
        item.returnImgApprovalStatus = '延迟' + item.returnImgApprovalDelay + '小时'
      } else if (item.returnImgApprovalStatus === 2 && item.returnImgApprovalDelay !== 0 && item.returnImgApprovalTime !== 0) {
        item.returnImgApprovalStatus = '延迟' + item.returnImgApprovalDelay + '小时' + dateConvert(item.returnImgApprovalTime)
      }
      if (item.prePayStatus === 1 && item.prePayTime === 0) {
        item.prePayStatus = '正常'
      } else if (item.prePayStatus === 1 && item.prePayTime !== 0) {
        item.prePayStatus = '正常' + dateConvert(item.prePayTime)
      } else if (item.prePayStatus === 2 && item.prePayDelay === 0) {
        item.prePayStatus = '延迟'
      } else if (item.prePayStatus === 2 && item.prePayDelay !== 0) {
        item.prePayStatus = '延迟' + item.prePayDelay + '小时'
      } else if (item.prePayStatus === 2 && item.prePayDelay !== 0 && item.prePayTime !== 0) {
        item.prePayStatus = '延迟' + item.prePayDelay + '小时' + dateConvert(item.prePayTime)
      }
      if (item.arrivePayStatus === 1 && item.arrivePayTime === 0) {
        item.arrivePayStatus = '正常'
      } else if (item.arrivePayStatus === 1 && item.arrivePayTime !== 0) {
        item.arrivePayStatus = '正常' + dateConvert(item.arrivePayTime)
      } else if (item.arrivePayStatus === 2 && item.arrivePayDelay === 0) {
        item.arrivePayStatus = '延迟'
      } else if (item.arrivePayStatus === 2 && item.arrivePayDelay !== 0) {
        item.arrivePayStatus = '延迟' + item.arrivePayDelay + '小时'
      } else if (item.arrivePayStatus === 2 && item.arrivePayDelay !== 0 && item.arrivePayTime !== 0) {
        item.arrivePayStatus = '延迟' + item.arrivePayDelay + '小时' + dateConvert(item.arrivePayTime)
      }
      if (item.tailPayStatus === 1 && item.tailPayTime === 0) {
        item.tailPayStatus = '正常'
      } else if (item.tailPayStatus === 1 && item.tailPayTime !== 0) {
        item.tailPayStatus = '正常' + dateConvert(item.tailPayTime)
      } else if (item.tailPayStatus === 2 && item.tailPayDelay === 0) {
        item.tailPayStatus = '延迟'
      } else if (item.tailPayStatus === 2 && item.tailPayDelay !== 0) {
        item.tailPayStatus = '延迟' + item.tailPayDelay + '小时'
      } else if (item.tailPayStatus === 2 && item.tailPayDelay !== 0 && item.tailPayTime !== 0) {
        item.tailPayStatus = '延迟' + item.tailPayDelay + '小时' + dateConvert(item.tailPayTime)
      }
      if (item.reportHandleStatus === 1 && item.reportHandleTime === 0) {
        item.reportHandleStatus = '正常'
      } else if (item.reportHandleStatus === 1 && item.reportHandleTime !== 0) {
        item.reportHandleStatus = '正常' + dateConvert(item.reportHandleTime)
      } else if (item.reportHandleStatus === 2 && item.reportHandleDelay === 0) {
        item.reportHandleStatus = '延迟'
      } else if (item.reportHandleStatus === 2 && item.reportHandleDelay !== 0) {
        item.reportHandleStatus = '延迟' + item.reportHandleDelay + '小时'
      } else if (item.reportHandleStatus === 2 && item.reportHandleDelay !== 0 && item.reportHandleTime !== 0) {
        item.reportHandleStatus = '延迟' + item.reportHandleDelay + '小时' + dateConvert(item.reportHandleTime)
      }
      if (item.damageApprovalStatus === 1 && item.damageApprovalTime === 0) {
        item.damageApprovalStatus = '正常'
      } else if (item.damageApprovalStatus === 1 && item.damageApprovalTime !== 0) {
        item.damageApprovalStatus = '正常' + dateConvert(item.damageApprovalTime)
      } else if (item.damageApprovalStatus === 2 && item.damageApprovalDelay === 0) {
        item.damageApprovalStatus = '延迟'
      } else if (item.damageApprovalStatus === 2 && item.damageApprovalDelay !== 0) {
        item.damageApprovalStatus = '延迟' + item.damageApprovalDelay + '小时'
      } else if (item.damageApprovalStatus === 2 && item.damageApprovalDelay !== 0 && item.damageApprovalTime !== 0) {
        item.damageApprovalStatus = '延迟' + item.damageApprovalDelay + '小时' + dateConvert(item.damageApprovalTime)
      }
      if (item.deviateWay) {
        item.deviateWay = (item.deviateWay * 1).toFixed(2) + 'KM'
      }
      if (item.location !== '' && item.locationTime !== 0) {
        item.location = item.location + dateConvert(item.locationTime)
      } else if (item.location === '' && item.locationTime !== 0) {
        item.location = dateConvert(item.locationTime)
      } else if (item.location !== '' && item.locationTime === 0) {
        item.location = item.location
      } else {
        item.location = '- -'
      }
    })

    var data = [], list = [{}].concat(list);
    layui.each(list, function (index2, item2) {
      var dataItem = {};
      layui.each(tableCols, function (index, item) {
        if (item.field && item.hide != true && item.field != 'operation') {
          if (index2 == 0) {
            dataItem[item.field] = item.title;
          } else {
            dataItem[item.field] = item2[item.field] || '- -'
          }
        }
      })
      data.push(dataItem)
    })
    excel.exportExcel({ sheet1: data }, '订单列表.xlsx', 'xlsx');
    exportLog();
  }

  function exportLog () {
    var params = {
      operationModule: 18,
      operationRemark: "导出订单数据"
    }
    edipao.exportLog(params);
  }


  table.on('toolbar(costList3)', handleEvent);
  table.on('tool(costList3)', handleEvent);
  table.on('checkbox(costList3)', handleEvent);
})
</script>
</body>
</html>
